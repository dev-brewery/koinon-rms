# docker-compose.ci.yml
# CI services for self-hosted GitHub Actions runners
#
# Prerequisites (one-time setup on host):
#   1. Create the CI network: docker network create koinon-ci
#   2. Connect each runner container: docker network connect koinon-ci <runner-container>
#
# Usage in CI workflows:
#   export COMPOSE_PROJECT_NAME="ci-${GITHUB_RUN_ID}"
#   docker-compose -f docker-compose.ci.yml up -d --wait
#   # Connect using container names: ci-postgres-${GITHUB_RUN_ID}, ci-redis-${GITHUB_RUN_ID}
#   docker-compose -f docker-compose.ci.yml down

services:
  postgres:
    image: postgis/postgis:16-3.5-alpine
    container_name: ci-postgres-${RUN_ID:-default}
    environment:
      POSTGRES_USER: koinon
      POSTGRES_PASSWORD: koinon
      POSTGRES_DB: koinon
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U koinon -d koinon"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - koinon-ci

  redis:
    image: redis:7-alpine
    container_name: ci-redis-${RUN_ID:-default}
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - koinon-ci

networks:
  koinon-ci:
    external: true
