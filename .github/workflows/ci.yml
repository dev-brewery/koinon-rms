name: CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  DOTNET_VERSION: '8.0.x'
  NODE_VERSION: '20.x'
  POSTGRES_VERSION: '16'

jobs:
  # Backend build and test
  backend:
    name: Backend Build & Test
    runs-on: ubuntu-latest

    permissions:
      checks: write
      contents: read

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: koinon
          POSTGRES_PASSWORD: koinon_test
          POSTGRES_DB: koinon_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        global-json-file: global.json

    - name: Restore dependencies
      run: dotnet restore

    - name: Check code formatting
      run: dotnet format --verify-no-changes --verbosity diagnostic

    - name: Build solution
      run: dotnet build --no-restore --configuration Release

    - name: Run unit tests
      run: dotnet test --no-build --configuration Release --verbosity normal --logger "trx;LogFileName=test-results.trx"
      env:
        ConnectionStrings__KoinonDb: "Host=localhost;Port=5432;Database=koinon_test;Username=koinon;Password=koinon_test"
        ConnectionStrings__Redis: "localhost:6379"

    - name: Publish test results
      uses: dorny/test-reporter@v1
      if: always()
      with:
        name: Backend Tests
        path: '**/test-results.trx'
        reporter: dotnet-trx

    - name: Upload coverage reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: backend-coverage
        path: '**/coverage.cobertura.xml'

  # Frontend build and test
  frontend:
    name: Frontend Build & Test
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: src/web

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: src/web/package-lock.json

    - name: Install dependencies
      run: npm ci

    - name: Run linter
      run: npm run lint

    - name: Run type checking
      run: npm run typecheck

    - name: Run tests
      run: npm test -- --coverage

    - name: Build production bundle
      run: npm run build

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: frontend-build
        path: src/web/dist

    - name: Upload coverage reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: frontend-coverage
        path: src/web/coverage

  # Migration safety check
  migration-check:
    name: Migration Safety Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    permissions:
      checks: write
      contents: read

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: koinon
          POSTGRES_PASSWORD: koinon_test
          POSTGRES_DB: koinon_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Install EF Core tools
      run: dotnet tool update --global dotnet-ef --version 8.0.11 || dotnet tool install --global dotnet-ef --version 8.0.11

    - name: Check for migrations
      id: check-migrations
      run: |
        MIGRATIONS=$(find src/Koinon.Infrastructure/Migrations -name "*.cs" -newer .git/FETCH_HEAD 2>/dev/null | wc -l)
        echo "count=$MIGRATIONS" >> $GITHUB_OUTPUT

    - name: Validate migrations can apply
      if: steps.check-migrations.outputs.count > 0
      run: |
        dotnet ef database update --project src/Koinon.Infrastructure --startup-project src/Koinon.Api
      env:
        ConnectionStrings__KoinonDb: "Host=localhost;Port=5432;Database=koinon_test;Username=koinon;Password=koinon_test"

    - name: Check for destructive changes
      if: steps.check-migrations.outputs.count > 0
      run: |
        # Check for DROP statements in new migrations
        if git diff origin/main...HEAD -- "src/Koinon.Infrastructure/Migrations/*.cs" | grep -i "DropColumn\|DropTable"; then
          echo "⚠️ WARNING: Destructive migration detected!"
          echo "Please review the migration carefully and ensure data backup procedures are in place."
          exit 1
        fi

  # Integration smoke test
  integration:
    name: Integration Smoke Test
    runs-on: ubuntu-latest
    needs: [backend, frontend]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Start services with docker-compose
      run: docker-compose up -d

    - name: Wait for services to be ready
      run: |
        timeout 60 bash -c 'until docker-compose exec -T postgres pg_isready; do sleep 2; done'
        timeout 60 bash -c 'until docker-compose exec -T redis redis-cli ping; do sleep 2; done'

    - name: Check API health
      run: |
        # TODO(#39): Once API is running, add health check
        echo "API health check placeholder"

    - name: Check database connectivity
      run: |
        docker-compose exec -T postgres psql -U koinon -d koinon -c "SELECT 1"

    - name: Cleanup
      if: always()
      run: docker-compose down -v

  # Work unit validation
  work-unit-validation:
    name: Work Unit Validation
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check work-units.json is updated
      run: |
        if [ -f .claude/work-units.json ]; then
          echo "✅ Work units tracker exists"
          cat .claude/work-units.json
        else
          echo "⚠️ Work units tracker not found - creating empty tracker"
          mkdir -p .claude
          echo '{"completed":[],"in_progress":null,"blocked":[]}' > .claude/work-units.json
        fi

    - name: Validate JSON format
      run: |
        if [ -f .claude/work-units.json ]; then
          python3 -m json.tool .claude/work-units.json > /dev/null
          echo "✅ work-units.json is valid JSON"
        fi

  # Summary job
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [backend, frontend, migration-check, integration, work-unit-validation]
    if: always()
    steps:
    - name: Check all jobs
      run: |
        if [[ "${{ needs.backend.result }}" == "success" ]] && \
           [[ "${{ needs.frontend.result }}" == "success" ]] && \
           [[ "${{ needs.migration-check.result }}" == "success" || "${{ needs.migration-check.result }}" == "skipped" ]] && \
           [[ "${{ needs.integration.result }}" == "success" ]] && \
           [[ "${{ needs.work-unit-validation.result }}" == "success" || "${{ needs.work-unit-validation.result }}" == "skipped" ]]; then
          echo "✅ All CI checks passed"
          exit 0
        else
          echo "❌ One or more CI checks failed"
          exit 1
        fi
